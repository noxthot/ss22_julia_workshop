<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="/ss22_julia_workshop/libs/katex/katex.min.css">
     
   <link rel="stylesheet" href="/ss22_julia_workshop/libs/highlight/github.min.css">
   
    <script src="/ss22_julia_workshop/libs/clipboard.min.js"></script>
  
  
  <script src="/ss22_julia_workshop/libs/plotly-1_58_5.min.js"></script> 
  <script>
    // This function is used when calling `\fig{...}` See # Using \fig{...} below
    const PlotlyJS_json = async (div, url) => {
      response = await fetch(url); // get file
      fig = await response.json(); // convert it to json
      // Make the plot fit the screen responsively. See the documentation of plotly.js. https://plotly.com/javascript/responsive-fluid-layout/
      if (typeof fig.config === 'undefined') { fig["config"]={} }
      delete fig.layout.width
      delete fig.layout.height
      fig["layout"]["autosize"] = true
      fig["config"]["autosizable"] = true
      fig["config"]["responsive"] = true

      // make it easier to scroll throught the website rather than being blocked by a figure.
      fig.config["scrollZoom"] = false

      // PlotlyJS.savefig by default add the some more attribute to make a static plot.
      // Disable them to make the website fancier.
      delete fig.config.staticPlot
      delete fig.config.displayModeBar
      delete fig.config.doubleClick
      delete fig.config.showTips

      Plotly.newPlot(div, fig);
    };
  </script>
  
  <link rel="stylesheet" href="/ss22_julia_workshop/css/jtd.css">
<link rel="stylesheet" href="/ss22_julia_workshop/css/extras.css">
<link rel="icon" href="/ss22_julia_workshop/assets/favicon.ico">

<style>
  /* #148 wrap long header */
  .franklin-content a.header-anchor,
  .franklin-toc li a
   {
    word-wrap: break-word;
    white-space: normal;
  }
</style>

   <title>Sheet 3</title>  
</head>
<body>                      <!-- closed in foot.html -->
<div class="page-wrap">   <!-- closed in foot.html -->
  <!-- SIDE BAR -->
  <div class="side-bar">
    <div class="header">
      <a href="/ss22_julia_workshop/" class="title">
        Julia
      </a>
    </div>
    <label for="show-menu" class="show-menu">MENU</label>
    <input type="checkbox" id="show-menu" role="button">
    <div class="menu" id="side-menu">
      <ul class="menu-list">
        <li class="menu-list-item "><a href="/ss22_julia_workshop/" class="menu-list-link ">Start</a>
        <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/" class="menu-list-link ">Introduction</a>
          <ul class="menu-list-child-list ">
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/basis_datatypes_and_operations/" class="menu-list-link ">Basic Data Types and Operations</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/package_manager/" class="menu-list-link ">Package Manager</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/matrix_vectors/" class="menu-list-link ">Matrix and Vector Operations</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/conditional_evaluations/" class="menu-list-link ">Conditional evaluations</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/loops/" class="menu-list-link ">Loops</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/functions/" class="menu-list-link ">Functions</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/macros/" class="menu-list-link ">Macros</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/worksheet_1/" class="menu-list-link ">Worksheet 1</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/worksheet_2/" class="menu-list-link ">Worksheet 2</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/introduction/pluto/" class="menu-list-link ">Pluto Notebook</a>
          </ul>
        <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/datascience/" class="menu-list-link ">Data Science</a>
          <ul class="menu-list-child-list ">
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/datascience/loading_data/" class="menu-list-link ">Loading data</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/datascience/saving_data/" class="menu-list-link ">Saving data</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/datascience/exploratory_da/" class="menu-list-link ">Exploratory Data Analysis</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/datascience/datasets/" class="menu-list-link ">Data Sets</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/datascience/unsupervised_learning/" class="menu-list-link ">Unsupervised Learning</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/datascience/supervised_learning/" class="menu-list-link ">Supervised Learning</a>
          </ul>
        <li class="menu-list-item active"><a href="/ss22_julia_workshop/pages/hpc/" class="menu-list-link active">Parallel computing</a>
          <ul class="menu-list-child-list ">
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/hpc/performance/" class="menu-list-link ">Measuring performance</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/hpc/simd/" class="menu-list-link ">Single Instruction Multiple Data</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/hpc/pi/" class="menu-list-link ">&pi; example</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/hpc/multithreading/" class="menu-list-link ">Multithreading</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/hpc/distributed/" class="menu-list-link ">Distributed computing</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/hpc/gpu/" class="menu-list-link ">GPU computing</a>
            <li class="menu-list-item "><a href="/ss22_julia_workshop/pages/hpc/worksheet_3/" class="menu-list-link active">Worksheet 3</a>
          </ul>
      </ul>
    </div>
    <div class="footer">
      This is <em>Just the docs</em>, adapted from the <a href="https://github.com/pmarsceill/just-the-docs" target="_blank">Jekyll theme</a>.
    </div>
  </div>
  <!-- CONTENT -->
  <div class="main-content-wrap"> <!-- closed in foot.html -->
    <div class="main-content">    <!-- closed in foot.html -->
      <div class="main-header">
        SS22 Scientific Coding with Julia
      </div>



<!-- Content appended here (in class franklin-content) -->
<div class="franklin-content"><h1 id="hpc_for_radiation_transport"><a href="#hpc_for_radiation_transport" class="header-anchor">HPC for radiation transport</a></h1>
<p>Maybe you have noticed that the number of velocities heavily effect the accuracy of the numerical solution. In radiation therapy, one needs to use a large number of spatial cells and velocities to make sure the error that we make through the discretization is small. Quite naturally, we should therefore think about how can we use modern computer architectures to speed up convergence. Take a few moments to think about how this can be done. Also, don&#39;t forget that certain parts of the program are already using many of the discussed HPC concepts automatically. So be careful when trying to speed up your code, since it might interfer with the parallelism that Julia took care of for you.</p>
<h2 id="gpu_computing"><a href="#gpu_computing" class="header-anchor">GPU Computing</a></h2>
<p>In the following, we extend the Code from <a href="../introduction/worksheet_2.md">worksheet 2</a> to GPUs. First, make sure you have CUDA installed and use it in your Julia file. Now think about what datatype your GPU can handle. In case you do not have access to a scientific &#40;and very expensive&#41; GPU that can handle <code>Float64</code> datatypes, make sure the code is using single precision floats. </p>
<button type="button" class="collapsible" style="background-color:#fffca5"> Solution </button><div class="collapsiblecontent">  Since we have implemented types in <a href="../introduction/worksheet_2.md">worksheet 2</a>, it is straightforward to change to single precision accuracy. Simply call the settings struct with</p>
<pre><code class="julia hljs"><span class="hljs-comment"># generate setup</span>
nx = <span class="hljs-number">101</span>
nv = <span class="hljs-number">10</span>
sigma2 = <span class="hljs-built_in">Float32</span>(<span class="hljs-number">0.0009</span>)
settings = Settings(nx,nv,sigma2)</code></pre>
<p></div>
<p>Now, make sure that all arrays that you use in the main time loop are of type <code>CuArray</code>. Note that it might be beneficial to not directly perform all operations of your code on your GPU. Whenever you access indices, it might make more sense to work on the CPU. You can cast your data arrays to type <code>CuArray</code> once everything is set up.</p>
<p>To illustrate how to move the computation to the GPU, let us look writing the initial condition. Try to run the two implementations</p>
<pre><code class="julia hljs">T = <span class="hljs-built_in">Float32</span>
nx = <span class="hljs-number">100</span>
nv = <span class="hljs-number">100</span>
x = collect(range(obj.a, obj.b; length=nx))

<span class="hljs-comment"># setup initial condition</span>
ψ = zeros(T, nx, nv)

<span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:nx
    ψ[j, :] .= IC(obj, x[j])
<span class="hljs-keyword">end</span></code></pre>
<p>as well as</p>
<pre><code class="julia hljs">T = <span class="hljs-built_in">Float32</span>
nx = <span class="hljs-number">100</span>
nv = <span class="hljs-number">100</span>
x = collect(range(obj.a, obj.b; length=nx))

<span class="hljs-comment"># setup initial condition</span>
ψ = zeros(T, nx, nv)

<span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:nx
    ψ[j, :] .= IC(obj, x[j])
<span class="hljs-keyword">end</span>

ψ = CuArray(ψ)</code></pre>
<p>Which one is faster and why? Use these observations to ensure your main time loop uses GPU arrays. Once you are confident your implementation should work, run it on the GPU. And since you expect to be super fast now, why not use <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5000</mn></mrow><annotation encoding="application/x-tex">5000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5000</span></span></span></span> spatial points and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn></mrow><annotation encoding="application/x-tex">1000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1000</span></span></span></span> velocity points? See how much the solution changes.</p>
<button type="button" class="collapsible" style="background-color:#fffca5"> Solution </button><div class="collapsiblecontent">  One possible GPU implementation looks like the following. Note that we abandon sparse matrices. To use sparse matrices on the GPU, we can employ the <code>CuSparseMatrixCSC</code> in the <code>CuSparse</code> package.</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> FastGaussQuadrature
<span class="hljs-keyword">using</span> LaTeXStrings
<span class="hljs-keyword">using</span> LinearAlgebra
<span class="hljs-keyword">using</span> Plots; gr()
<span class="hljs-keyword">using</span> CUDA

<span class="hljs-keyword">struct</span> Settings{T&lt;:<span class="hljs-built_in">AbstractFloat</span>}
  nx::<span class="hljs-built_in">Int</span> <span class="hljs-comment"># number of spatial cells</span>
  nv::<span class="hljs-built_in">Int</span> <span class="hljs-comment"># number of velocity points</span>
  nt::<span class="hljs-built_in">Int</span> <span class="hljs-comment"># number of time steps</span>
  Δt::T <span class="hljs-comment"># time step size</span>
  Δx::T <span class="hljs-comment"># spatial grid cell size</span>
  tEnd::T <span class="hljs-comment"># end time of simulation</span>
  a::T <span class="hljs-comment"># start point of spatial domain</span>
  b::T <span class="hljs-comment"># end point of spatial domain</span>
  sigma2::T <span class="hljs-comment"># variance of initial condition</span>

  <span class="hljs-keyword">function</span> Settings(nx::<span class="hljs-built_in">Int</span>=<span class="hljs-number">101</span>, nv::<span class="hljs-built_in">Int</span>=<span class="hljs-number">10</span>, sigma2::T=<span class="hljs-number">0.0009</span>) <span class="hljs-keyword">where</span> {T&lt;:<span class="hljs-built_in">AbstractFloat</span>}
    tEnd = <span class="hljs-number">0.4</span>
    a = -<span class="hljs-number">1.0</span>
    b = <span class="hljs-number">1.0</span>
    Δx = (b - a) / (nx - <span class="hljs-number">1</span>)
    Δt = Δx
    nt = <span class="hljs-built_in">Int</span>(floor(tEnd / Δt))

    <span class="hljs-keyword">return</span> new{T}(nx, nv, nt, Δt, Δx, tEnd, a, b, sigma2)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># definition of the initial condition</span>
<span class="hljs-keyword">function</span> IC(obj::Settings, x::T) <span class="hljs-keyword">where</span> T&lt;:<span class="hljs-built_in">Real</span>
  floor = T(<span class="hljs-number">1e-4</span>)
  <span class="hljs-keyword">return</span> max(floor, <span class="hljs-number">1.0</span> / (sqrt(<span class="hljs-number">2</span> * <span class="hljs-literal">pi</span> * obj.sigma2)) * exp(-(x - <span class="hljs-number">0.5</span> * (obj.b - obj.a) - obj.a)^<span class="hljs-number">2</span> / (<span class="hljs-number">2.0</span> * obj.sigma2)))
<span class="hljs-keyword">end</span>

<span class="hljs-keyword">function</span> runPlaneSource(obj::Settings{T}) <span class="hljs-keyword">where</span> {T}
    nx = obj.nx
    nv = obj.nv

    <span class="hljs-comment"># define velocity grid according to gauss quadrature</span>
    v, w = convert.(<span class="hljs-built_in">Vector</span>{T}, gausslegendre(nv))
    x = collect(range(obj.a, obj.b; length=nx))

    <span class="hljs-comment"># setup initial condition</span>
    ψ = zeros(T, nx, nv)

    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:nx
        ψ[j, :] .= IC(obj, x[j])
    <span class="hljs-keyword">end</span>

    ψ = CuArray(ψ)

    <span class="hljs-comment"># create stencil matrices</span>
    Δx = obj.Δx
    D⁺ = CuArray((<span class="hljs-number">1</span> / Δx) * Tridiagonal(-ones(T, nx - <span class="hljs-number">1</span>), ones(T, nx), zeros(T, nx - <span class="hljs-number">1</span>)))
    D⁻ = CuArray((<span class="hljs-number">1</span> / Δx) * Tridiagonal(zeros(T, nx - <span class="hljs-number">1</span>), -ones(T, nx), ones(T, nx - <span class="hljs-number">1</span>)))

    <span class="hljs-comment"># create system matrices</span>
    midMinus = <span class="hljs-built_in">Int</span>(ceil(nv / <span class="hljs-number">2</span>))
    midPlus = <span class="hljs-built_in">Int</span>(floor(nv / <span class="hljs-number">2</span>))
    V⁻ = CuArray(Diagonal([v[<span class="hljs-number">1</span>:midMinus]; zeros(midPlus)]))
    V⁺ = CuArray(Diagonal([zeros(midMinus); v[(midPlus + <span class="hljs-number">1</span>):<span class="hljs-keyword">end</span>]]))

    <span class="hljs-comment"># create scattering matrix</span>
    w = CuArray(w)
    G = CUDA.ones(T, nv, nv) .* w - I

    <span class="hljs-comment"># advance in time</span>
    Δt = obj.Δt
    nT = obj.nt

    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:nT
        ψ .= ψ + Δt * (-D⁺ * ψ * V⁺ - D⁻ * ψ * V⁻ + ψ * G)
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># store Φ for plotting</span>
    Φ = zeros(T, nx)

    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>:nx
        Φ[j] = sum(ψ[j, :] .* w)
    <span class="hljs-keyword">end</span>

    <span class="hljs-keyword">return</span> x, Φ
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># generate setup</span>
nx = <span class="hljs-number">1001</span>
nv = <span class="hljs-number">1000</span>
sigma2 = <span class="hljs-built_in">Float32</span>(<span class="hljs-number">0.0009</span>)
settings = Settings(nx, nv, sigma2)

<span class="hljs-comment"># run code and store final Φ</span>
x, Φ = runPlaneSource(settings)

<span class="hljs-comment"># plot Φ</span>
plot(x, Φ, labels=<span class="hljs-string">L&quot;\Phi&quot;</span>)
xlabel!(<span class="hljs-string">&quot;x&quot;</span>)</code></pre>
<p></div>
<div class="page-foot">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> - <a href="https://ehrensperger.dev/">Gregor Ehrensperger</a>, <a href="https://lfuonline.uibk.ac.at/public/people.vcard?id=59131">Peter Kandolf</a>, <a href="https://lfuonline.uibk.ac.at/public/people.vcard?id=415344">Jonas Kusch</a>. Last modified: November 21, 2022.
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div><!-- CONTENT ENDS HERE -->
    </div> <!-- end of class main-content -->
    </div> <!-- end of class main-content-wrap -->
    </div> <!-- end of class page-wrap-->
    
      



    
    
      


      <script>
    (function(){
    
      // Get the elements.
      // - the 'pre' element.
      // - the 'div' with the 'paste-content' id.
    
      var pre = document.getElementsByTagName('pre');
    
      // Add a copy button in the 'pre' element.
      // which only has the className of 'language-'.
    
      for (var i = 0; i < pre.length; i++) {
        var isLanguage = pre[i].children[0].tagName == 'CODE';
    
        if ( isLanguage ) {
          var button           = document.createElement('button');
              button.className = 'copy-button';
              button.textContent = 'Copy';
    
              pre[i].appendChild(button);
        }
      };
    
      // Run Clipboard
    
      var copyCode = new Clipboard('.copy-button', {
        target: function(trigger) {
          return trigger.previousElementSibling;
        }
      });
    
      // On success:
      // - Change the "Copy" text to "Copied".
      // - Swap it to "Copy" in 2s.
      // - Lead user to the "contenteditable" area with Velocity scroll.
    
      copyCode.on('success', function(event) {
        event.clearSelection();
        event.trigger.textContent = 'Copied';
        window.setTimeout(function() {
          event.trigger.textContent = 'Copy';
        }, 2000);
    
      });
    
      // On error (Safari):
      // - Change the  "Press Ctrl+C to copy"
      // - Swap it to "Copy" in 2s.
    
      copyCode.on('error', function(event) {
        event.trigger.textContent = 'Press "Ctrl + C" to copy';
        window.setTimeout(function() {
          event.trigger.textContent = 'Copy';
        }, 5000);
      });
    
    })();
</script>
    
  </body>
</html>

<script>
  var coll = document.getElementsByClassName("collapsible");
  var i;

  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });
  }
</script>

<script>
  var coll = document.getElementsByClassName("solutioncollapsible");
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const myVar = urlParams.get('solution')
  if ( myVar == 'true') {
    for (i = 0; i < coll.length; i++) {
      coll[i].style.display = "block";
    }
  }
</script>